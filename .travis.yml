# Travis CI Configuration File

# Tell Travis CI we're using PHP
language: php

# PHP version used in first build configuration.
php:
  - "5.4"
  - "5.5"
  - "5.6"

# WordPress version used in first build configuration.
env:
  - WP_VERSION=master

# we will build a matrix of PHP to WP_VERSIONs later. 
matrix:
  allow_failures:
  - php: hhvm

install:
  # install codeception 
  - wget http://codeception.com/codecept.phar
  - chmod +x codecept.phar
  - sudo mv codecept.phar /usr/local/bin/codecept
  
  # Selenium server
  - wget http://selenium-release.storage.googleapis.com/2.42/selenium-server-standalone-2.42.2.jar
  
  # Composer
  - composer install --prefer-dist 


before_script:
  # launch selenium server
  - java -jar selenium-server-standalone-2.42.2.jar -port 4444 > /dev/null
  
  # give 5 seconds to let server load
  - sleep 5  
  
  - export PLUGIN_SLUG=$(basename $(pwd)) 
  
  # isntall wordpress
  - git clone --depth=50 --branch="$WP_VERSION" git://develop.git.wordpress.org/ /tmp/wordpress

  # pull latests inbound plugins
  - git clone --branch="master" https://github.com/inboundnow/cta.git /tmp/wordpress/wp-content/plugins/cta
  - git clone --branch="master" https://github.com/inboundnow/leads.git /tmp/wordpress/wp-content/plugins/leads

  # drop back a directory
  - cd ..
  
  # make a directory for landing pages
  - mv "$PLUGIN_SLUG" "/tmp/wordpress/src/wp-content/plugins/$PLUGIN_SLUG"
  - cd /tmp/wordpress
  
  # create database
  - mysql -e "CREATE DATABASE wordpress_tests;" -uroot
  - cp wp-tests-config-sample.php wp-tests-config.php
  - sed -i "s/youremptytestdbnamehere/wordpress_tests/" wp-tests-config.php
  - sed -i "s/yourusernamehere/travis/" wp-tests-config.php
  - sed -i "s/yourpasswordhere//" wp-tests-config.php
  - cd "/tmp/wordpress/src/wp-content/plugins/$PLUGIN_SLUG"
  - ls -l
  
  #setup virtual hosts from travis-ci-apache file template
  - sudo cp -f TRAVIS_BUILD_DIR/tests/travis-ci-apache /etc/apache2/sites-available/default
  

script: 
  - phpunit
  - php codecept run
  
addons:
  hosts:
    - inboundsoon.dev